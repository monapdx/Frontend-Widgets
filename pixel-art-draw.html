<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Pixel Art Drawing App</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,700;1,400;1,700&display=swap");
    @import url("https://fonts.googleapis.com/css2?family=Lobster&family=Tiny5&display=swap");

    body {
      font-family: "IBM Plex Mono", monospace;
      text-align: center;
      margin: 0;
      padding: 18px;
      background: #f6f8fa;
    }

    h1 {
      margin: 8px 0 6px;
    }

    .panel {
      max-width: 820px;
      margin: 0 auto;
      padding: 14px 14px 10px;
      background: white;
      border: 1px solid #e6e6e6;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px 14px;
      align-items: center;
      margin: 10px 0 6px;
    }

    .controls .group {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: center;
    }

    label {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      background: #f3f4f6;
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid #e7e7e7;
    }

    select, input[type="color"] {
      cursor: pointer;
    }

    button {
      background: #111;
      color: #fff;
      border: none;
      padding: 8px 14px;
      cursor: pointer;
      border-radius: 10px;
      transition: 0.15s ease;
      font-family: "Lobster", serif;
      font-size: 20px;
      line-height: 1.1em;
    }

    button:hover {
      background: #333;
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0px);
    }

    /* Eraser toggle visual state */
    #eraserToggle.selected {
      background: #b3006d;
    }

    #palette {
      margin: 10px auto 8px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 6px;
      max-width: 820px;
    }

    .color {
      display: inline-block;
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid #ddd;
      cursor: pointer;
      box-shadow: 0 1px 2px rgba(0,0,0,0.06);
    }

    .color.selected {
      border: 2px solid black;
      transform: translateY(-1px);
    }

    #gridWrap {
      display: flex;
      justify-content: center;
      margin-top: 10px;
    }

    #grid {
      display: grid;
      border: 1px solid #ddd;
      grid-gap: 1px;
      background: #ddd;
      border-radius: 12px;
      overflow: hidden;
      user-select: none;
      touch-action: none;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }

    .cell {
      background-color: white;
      width: 100%;
      height: 100%;
    }

    .hint {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <div class="panel">
    <h1>Pixel Art Drawing App</h1>

    <div id="palette"></div>

    <div class="controls">
      <div class="group">
        <input type="color" id="customColor" value="#000000" aria-label="Pick a custom color" />
        <button id="addColor">Add Custom Color</button>
      </div>

      <div class="group">
        <button id="saveDrawing">Save PNG</button>
        <button id="saveJSON">Export JSON</button>
        <button id="clearGrid">Clear</button>
      </div>

      <div class="group">
        <button id="eraserToggle">Eraser</button>

        <label>Brush Size:
          <select id="brushSize">
            <option value="1">1x1</option>
            <option value="2">2x2</option>
            <option value="3">3x3</option>
          </select>
        </label>

        <label>Grid Size:
          <select id="gridSelector">
            <option value="16">16x16</option>
            <option value="32" selected>32x32</option>
            <option value="48">48x48</option>
          </select>
        </label>
      </div>
    </div>

    <div class="hint">
      Tip: click + drag to paint. Eraser paints white. Export JSON lets you reload later if you add an importer.
    </div>

    <div id="gridWrap">
      <div id="grid"></div>
    </div>
  </div>

  <script>
    // Core elements
    const grid = document.getElementById('grid');
    const palette = document.getElementById('palette');
    const clearButton = document.getElementById('clearGrid');
    const saveButton = document.getElementById('saveDrawing');
    const customColorInput = document.getElementById('customColor');
    const addColorButton = document.getElementById('addColor');

    // New controls
    const gridSelector = document.getElementById('gridSelector');
    const brushSizeSelect = document.getElementById('brushSize');
    const eraserToggle = document.getElementById('eraserToggle');
    const saveJSONButton = document.getElementById('saveJSON');

    // Palette colors (your originals)
    const colors = [
      '#ff009c', '#04DAFC', '#0ABFBC', '#FFA500',
      '#b3006d', '#DA70D6', '#1E90FF', '#A8E6CE',
      '#FF8C94', 'black', 'white'
    ];

    // State
    let currentColor = 'black';
    let gridSize = 32;
    let brushSize = 1;
    let isErasing = false;

    // --- Helpers ---
    function setSelectedPaletteElement(el) {
      document.querySelectorAll('.color').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
    }

    function paintAtIndex(index) {
      for (let dy = 0; dy < brushSize; dy++) {
        for (let dx = 0; dx < brushSize; dx++) {
          const x = (index % gridSize) + dx;
          const y = Math.floor(index / gridSize) + dy;
          const newIndex = (y * gridSize) + x;

          const cell = grid.children[newIndex];
          if (!cell) continue;

          cell.style.backgroundColor = isErasing ? 'white' : currentColor;
        }
      }
    }

    // --- Grid creation ---
    function createGrid(size) {
      gridSize = size;
      grid.innerHTML = '';

      const cellPx = Math.max(10, Math.floor(640 / gridSize));
      grid.style.gridTemplateColumns = `repeat(${gridSize}, 1fr)`;
      grid.style.width = `${gridSize * cellPx}px`;
      grid.style.height = `${gridSize * cellPx}px`;

      for (let i = 0; i < gridSize * gridSize; i++) {
        const cell = document.createElement('div');
        cell.className = 'cell';

        cell.addEventListener('mousedown', () => paintAtIndex(i));
        cell.addEventListener('mouseover', (e) => {
          if (e.buttons === 1) paintAtIndex(i);
        });

        grid.appendChild(cell);
      }
    }

    // --- Palette creation ---
    function initPalette() {
      palette.innerHTML = '';

      colors.forEach(color => {
        const colorDiv = document.createElement('div');
        colorDiv.className = 'color';
        colorDiv.style.backgroundColor = color;

        colorDiv.addEventListener('click', () => {
          setSelectedPaletteElement(colorDiv);
          currentColor = color;
          isErasing = false;
          eraserToggle.classList.remove('selected');
        });

        palette.appendChild(colorDiv);
      });

      if (palette.children[0]) {
        palette.children[0].classList.add('selected');
        currentColor = colors[0];
      }
    }

    // --- Custom color add ---
    addColorButton.addEventListener('click', () => {
      const customColor = customColorInput.value || '#000000';

      const colorDiv = document.createElement('div');
      colorDiv.className = 'color';
      colorDiv.style.backgroundColor = customColor;

      colorDiv.addEventListener('click', () => {
        setSelectedPaletteElement(colorDiv);
        currentColor = customColor;
        isErasing = false;
        eraserToggle.classList.remove('selected');
      });

      palette.appendChild(colorDiv);

      setSelectedPaletteElement(colorDiv);
      currentColor = customColor;
      isErasing = false;
      eraserToggle.classList.remove('selected');
    });

    // --- Clear grid ---
    clearButton.addEventListener('click', () => {
      document.querySelectorAll('.cell').forEach(cell => {
        cell.style.backgroundColor = 'white';
      });
    });

    // --- Save PNG ---
    saveButton.addEventListener('click', () => {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');

      const outputSize = 800; // px width/height
      const cellSize = outputSize / gridSize;

      canvas.width = outputSize;
      canvas.height = outputSize;

      Array.from(grid.children).forEach((cell, index) => {
        const x = (index % gridSize) * cellSize;
        const y = Math.floor(index / gridSize) * cellSize;
        context.fillStyle = cell.style.backgroundColor || 'white';
        context.fillRect(x, y, cellSize, cellSize);
      });

      const link = document.createElement('a');
      link.download = 'drawing.png';
      link.href = canvas.toDataURL('image/png');
      link.click();
    });

    // --- Export JSON ---
    saveJSONButton.addEventListener('click', () => {
      const data = Array.from(grid.children).map(cell => cell.style.backgroundColor || 'white');
      const payload = { gridSize, pixels: data };

      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'pixel-art.json';
      link.click();
    });

    // --- Grid size selector ---
    gridSelector.addEventListener('change', () => {
      const newSize = parseInt(gridSelector.value, 10);
      if (!Number.isFinite(newSize)) return;
      createGrid(newSize);
    });

    // --- Brush size selector ---
    brushSizeSelect.addEventListener('change', () => {
      const v = parseInt(brushSizeSelect.value, 10);
      brushSize = Number.isFinite(v) ? v : 1;
    });

    // --- Eraser toggle ---
    eraserToggle.addEventListener('click', () => {
      isErasing = !isErasing;
      eraserToggle.classList.toggle('selected', isErasing);
    });

    // --- Init ---
    initPalette();
    createGrid(gridSize);

    gridSelector.value = String(gridSize);
    brushSizeSelect.value = String(brushSize);
  </script>
</body>
</html>
